"use strict";!function(){function e(e){n()}function t(e){c()}function o(){return j.classList.add("loaded"),setTimeout(function(e){j.querySelector(".loader").remove(),kenrobot.trigger("app","ready")},1e3),!0}function r(e,t){"scratch2"==t&&n(e)}function n(e){kenrobot.postMessage("app:projectOpen","scratch2",e).then(a,function(e){kenrobot.trigger("util","message",{text:"打开失败",type:"error"})})}function a(e){y={path:e.path,project_name:e.project_name},_.loadProject(e.data),y.project_name&&_.setProjectName(y.project_name),kenrobot.view.project=e.data,kenrobot.trigger("util","message","打开成功")}function c(e){var t=function(t){y.path?_.exportProject(e):e||!y.project_name?kenrobot.trigger("prompt","show",{title:"项目保存",placeholder:"项目名字",callback:function(t){t?(y.project_name=t,_.setProjectName(y.project_name),_.exportProject(e)):kenrobot.trigger("util","message",{text:"保存失败",type:"error"})}}):(y.project_name&&_.setProjectName(y.project_name),_.exportProject(e))};kenrobot.user||e||y.hasShowSave?t():(y.hasShowSave=!0,kenrobot.trigger("save","show",t))}function s(e,t){if(v){var o=kenrobot.view.project&&kenrobot.view.project!==e;v(o),v=null}else(t?kenrobot.postMessage("app:projectSaveAs",y.project_name,e,"scratch2"):kenrobot.postMessage("app:projectSave",y.project_name,e,"scratch2",y.path)).then(function(e){(y=Object.assign(y,e)).project_name&&_.setProjectName(y.project_name),kenrobot.trigger("util","message","保存成功"),kenrobot.view.project=e.data,D&&D(),D=null},function(e){kenrobot.trigger("util","message",{text:"保存失败",type:"error"}),D=null})}function i(e){v=e,_.exportProject()}function l(e){D=e,_.exportProject()}function u(){var e=[{key:["ctrl+n","command+n"],callback:function(e){return p("new-project")}},{key:["ctrl+o","command+o"],callback:function(e){return p("open-project")}},{key:["ctrl+s","command+s"],callback:function(e){return p("save-project")}},{key:["ctrl+shift+s","command+shift+s"],callback:function(e){return p("save-as-project")}}];kenrobot.delayTrigger(100,"shortcut","register",e)}function p(e){switch(e){case"new-project":y={},_.newProject();break;case"open-project":n(arguments.length<=1?void 0:arguments[1]);break;case"save-project":c();break;case"save-as-project":c(!0);break;case"is-project-changed":i(arguments.length<=1?void 0:arguments[1]);break;case"save-project-before-quit":l(arguments.length<=1?void 0:arguments[1]);break;case"undelete":_.undelete();break;case"toggle-samll-stage":_.toggleSmallStage();break;case"toggle-turbo-mode":_.toggleTurboMode();break;case"edit-block-colors":_.editBlockColors()}}function d(e){S=e,_.onSerialPortReady()}function g(e,t){S&&S==e&&k(t)}function U(e){S&&S==e&&(S=null,kenrobot.trigger("util","message",{text:"串口已断开",type:"error"}),_.onSerialPortClose())}function k(e){C.length>30&&(C=[]);for(var t=0;t<e.length;t++)if(C.push(e[t]),!(C.length<2)&&(85==C[C.length-1]&&255==C[C.length-2]&&(K=!0,L=C.length-2),13==C[C.length-1]&&K)){K=!1;var o=L+4,r=C[o],n=C[++o];o++;var a;switch(n){case 1:a=C[o],o++;break;case 2:a=f(C,o),o+=4;break;case 3:a=E(C,o),o+=2;break;case 4:var c=C[o];a=h(C,++o,c),o+=c;break;case 5:a=O(C,o),o+=4;break;case 6:a=T(C,o),o+=4}b(r,n,a),C=[]}}function b(e,t,o){t>6||t<0?_.responseValue():e==R.TUDOU_IR?(o=o>0?o:65536+o,_.responseValue(o)):_.responseValue(o)}function m(e){var t=new DataView(new ArrayBuffer(e.length));return e.forEach(function(e,o){return t.setUint8(o,e)}),t}function f(e,t){return m(e.slice(t,t+4)).getFloat32(0,!0)}function O(e,t){return f(e,t)}function T(e,t){return m(e.slice(t,t+4)).getInt32(0,!0)}function E(e,t){return m(e.slice(t,t+2)).getInt16(0,!0)}function h(e,t,o){return e.slice(t,t+o).map(function(e){return String.fromCharCode(e)}).join("")}var j,_,v,D,S,w=function(){function e(e){if(!o&&("onreadystatechange"!==e.type||"complete"===document.readyState)){for(var r=0;r<t.length;r++)t[r].call(document);o=!0,t=null}}var t=[],o=!1;return document.addEventListener?(document.addEventListener("DOMContentLoaded",e,!1),document.addEventListener("readystatechange",e,!1),window.addEventListener("load",e,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",e),window.attachEvent("onload",e)),function(e){o?e.call(document):t.push(e)}}(),y={},R={TUDOU_MOVE:52,TUDOU_STOP:53,TUDOU_BATTERY:54,TUDOU_OBSTACLE:55,TUDOU_TRACKING:56,TUDOU_LED:57,TUDOU_BUZZER:58,TUDOU_IR:59,TUDOU_SERVO:60,TUDOU_RGBLED:61,KEDOU_MOVE:62,KEDOU_STOP:63,KEDOU_BATTERY:64,KEDOU_OBSTACLE:65,KEDOU_TRACKING:66,KEDOU_VOICE:67},P={GET:1,RUN:2,RESET:4,START:5},C=(R.TUDOU_MOVE,R.TUDOU_STOP,R.TUDOU_BATTERY,R.TUDOU_OBSTACLE,R.TUDOU_TRACKING,R.TUDOU_LED,R.TUDOU_BUZZER,R.TUDOU_IR,R.TUDOU_SERVO,R.TUDOU_RGBLED,R.KEDOU_MOVE,R.KEDOU_STOP,R.KEDOU_BATTERY,R.KEDOU_OBSTACLE,R.KEDOU_TRACKING,R.KEDOU_VOICE,[]),K=!1,L=0;w(function(){window.kenrobot=window.kenrobot||top.kenrobot,_=document.getElementById("ken-scratch");var n=(j=document.querySelector(".player")).querySelector(".toolbar");window.JSeditorReady=o,kenrobot&&!kenrobot.isPC||n.remove(),kenrobot&&(kenrobot.isPC||(n.querySelector(".open").addEventListener("click",e),n.querySelector(".save").addEventListener("click",t)),kenrobot.view.saveProject=s,kenrobot.viewType="scratch2",u(),kenrobot.on("app","command",p).on("project","open-by",r).on("project","load",a).on("serial","ready",d).on("serial","data",g).on("serial","close",U))})}();