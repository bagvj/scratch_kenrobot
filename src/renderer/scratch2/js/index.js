"use strict";!function(){function e(e){n()}function t(e){a()}function o(){return O.classList.add("loaded"),setTimeout(function(e){O.querySelector(".loader").remove()},1e3),!0}function r(e,t){"scratch2"==t&&n(e)}function n(e){kenrobot.postMessage("app:projectOpen","scratch2",e).then(function(e){R={path:e.path,project_name:e.project_name},v.loadProject(e.data),R.project_name&&v.setProjectName(R.project_name),kenrobot.trigger("util","message","打开成功")},function(e){kenrobot.trigger("util","message",{text:"打开失败",type:"error"})})}function a(e){var t=function(t){R.path?v.exportProject(e):e||!R.project_name?kenrobot.trigger("prompt","show",{title:"项目保存",placeholder:"项目名字",callback:function(t){t?(R.project_name=t,v.setProjectName(R.project_name),v.exportProject(e)):kenrobot.trigger("util","message",{text:"保存失败",type:"error"})}}):(R.project_name&&v.setProjectName(R.project_name),v.exportProject(e))};kenrobot.user||e||R.hasShowSave?t():(R.hasShowSave=!0,kenrobot.trigger("save","show",t))}function c(e,t){(t?kenrobot.postMessage("app:projectSaveAs",R.project_name,e,"scratch2"):kenrobot.postMessage("app:projectSave",R.project_name,e,"scratch2",R.path)).then(function(e){(R=Object.assign(R,e)).project_name&&v.setProjectName(R.project_name),kenrobot.trigger("util","message","保存成功")},function(e){kenrobot.trigger("util","message",{text:"保存失败",type:"error"})})}function u(){var e=[{key:["ctrl+n","command+n"],callback:function(e){return s("new-project")}},{key:["ctrl+o","command+o"],callback:function(e){return s("open-project")}},{key:["ctrl+s","command+s"],callback:function(e){return s("save-project")}},{key:["ctrl+shift+s","command+shift+s"],callback:function(e){return s("save-as-project")}}];kenrobot.delayTrigger(100,"shortcut","register",e)}function s(e){switch(e){case"new-project":R={},v.newProject();break;case"open-project":n(arguments.length<=1?void 0:arguments[1]);break;case"save-project":a();break;case"save-as-project":a(!0);break;case"undelete":v.undelete();break;case"toggle-samll-stage":v.toggleSmallStage();break;case"toggle-turbo-mode":v.toggleTurboMode();break;case"edit-block-colors":v.editBlockColors()}}function i(e,t){if(L[t]){for(var o=arguments.length,r=Array(o>2?o-2:0),n=2;n<o;n++)r[n-2]=arguments[n];var a=L[t].concat(Array.from(r).map(function(e){return void 0!==w[e]?w[e]:e}));l.apply(this,a)}}function d(){kenrobot.trigger("serial","open")}function l(e){for(var t=arguments.length,o=Array(t>1?t-1:0),r=1;r<t;r++)o[r-1]=arguments[r];kenrobot.trigger("serial","sendPackage",[255,85,o.length+2,0,e].concat(o))}function _(e){D=e,v.onSerialPortReady()}function k(e,t){D&&D==e&&p(t)}function g(e){D&&D==e&&(D=null,kenrobot.trigger("util","message",{text:"串口已断开",type:"error"}),v.onSerialPortClose())}function p(e){P.length>30&&(P=[]);for(var t=0;t<e.length;t++)if(P.push(e[t]),!(P.length<2)&&(85==P[P.length-1]&&255==P[P.length-2]&&(C=!0,A=P.length-2),13==P[P.length-1]&&C)){C=!1;var o=A+4,r=P[o],n=P[++o];o++;var a;switch(n){case 1:a=P[o],o++;break;case 2:a=b(P,o),o+=4;break;case 3:a=T(P,o),o+=2;break;case 4:var c=P[o];a=h(P,++o,c),o+=c;break;case 5:a=m(P,o),o+=4;break;case 6:a=E(P,o),o+=4}f(r,n,a),P=[]}}function f(e,t,o){t>6||t<0?v.responseValue():e==y.TUDOU_IR?(o=o>0?o:65536+o,v.responseValue(o)):v.responseValue(o)}function U(e){var t=new DataView(new ArrayBuffer(e.length));return e.forEach(function(e,o){return t.setUint8(o,e)}),t}function b(e,t){return U(e.slice(t,t+4)).getFloat32(0,!0)}function m(e,t){return b(e,t)}function E(e,t){return U(e.slice(t,t+4)).getInt32(0,!0)}function T(e,t){return U(e.slice(t,t+2)).getInt16(0,!0)}function h(e,t,o){return e.slice(t,t+o).map(function(e){return String.fromCharCode(e)}).join("")}var O,v,D,j=function(){function e(e){if(!o&&("onreadystatechange"!==e.type||"complete"===document.readyState)){for(var r=0;r<t.length;r++)t[r].call(document);o=!0,t=null}}var t=[],o=!1;return document.addEventListener?(document.addEventListener("DOMContentLoaded",e,!1),document.addEventListener("readystatechange",e,!1),window.addEventListener("load",e,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",e),window.attachEvent("onload",e)),function(e){o?e.call(document):t.push(e)}}(),R={},y={TUDOU_MOVE:52,TUDOU_STOP:53,TUDOU_BATTERY:54,TUDOU_OBSTACLE:55,TUDOU_TRACKING:56,TUDOU_LED:57,TUDOU_BUZZER:58,TUDOU_IR:59,TUDOU_SERVO:60,TUDOU_RGBLED:61,KEDOU_MOVE:62,KEDOU_STOP:63,KEDOU_BATTERY:64,KEDOU_OBSTACLE:65,KEDOU_TRACKING:66,KEDOU_VOICE:67},S={GET:1,RUN:2,RESET:4,START:5},w={tudou_forward:1,tudou_back:2,tudou_turnLeft:3,tudou_turnRight:4,tudou_forwardLeft:1,tudou_forwardRight:2,tudou_backLeft:3,tudou_backRight:4,tudou_on:1,tudou_off:0,kedou_forward:1,kedou_back:2,kedou_turnLeft:3,kedou_turnRight:4,kedou_left:1,kedou_center:2,kedou_right:3,kedou_leftEdge:1,kedou_leftCenter:2,kedou_rightCenter:3,kedou_rightEdge:4,kedou_sound_1:1,kedou_sound_2:2,kedou_sound_3:3,kedou_sound_4:4},L={tudou_move:[S.RUN,y.TUDOU_MOVE],tudou_stop:[S.RUN,y.TUDOU_STOP],tudou_battery:[S.GET,y.TUDOU_BATTERY],tudou_obstacle:[S.GET,y.TUDOU_OBSTACLE],tudou_tracking:[S.GET,y.TUDOU_TRACKING],tudou_led:[S.RUN,y.TUDOU_LED],tudou_buzzer:[S.RUN,y.TUDOU_BUZZER],tudou_ir:[S.GET,y.TUDOU_IR],tudou_servo:[S.RUN,y.TUDOU_SERVO],tudou_rgbled:[S.RUN,y.TUDOU_RGBLED],kedou_move:[S.RUN,y.KEDOU_MOVE],kedou_stop:[S.RUN,y.KEDOU_STOP],kedou_battery:[S.GET,y.KEDOU_BATTERY],kedou_obstacle:[S.GET,y.KEDOU_OBSTACLE],kedou_tracking:[S.GET,y.KEDOU_TRACKING],kedou_sound:[S.RUN,y.KEDOU_VOICE]},P=[],C=!1,A=0;j(function(){window.kenrobot=window.kenrobot||top.kenrobot,v=document.getElementById("ken-scratch");var n=(O=document.querySelector(".player")).querySelector(".toolbar");window.JSeditorReady=o,kenrobot&&!kenrobot.isPC||n.remove(),kenrobot&&(kenrobot.isPC||(n.querySelector(".open").addEventListener("click",e),n.querySelector(".save").addEventListener("click",t)),kenrobot.view.callExt=i,kenrobot.view.openSerialPort=d,kenrobot.view.saveProject=c,kenrobot.viewType="scratch2",u(),kenrobot.on("app","command",s).on("project","open-by",r).on("serial","ready",_).on("serial","data",k).on("serial","close",g))})}();