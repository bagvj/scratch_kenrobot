"use strict";!function(){function e(e){r()}function t(e){a()}function o(){return O.classList.add("loaded"),setTimeout(function(e){O.querySelector(".loader").remove()},1e3),!0}function n(e,t){"scratch2"==t&&r(e)}function r(e){kenrobot.postMessage("app:projectNewOpen","scratch2",e).then(function(e){w=e.extra,v.loadProject(e.data),w.name&&v.setProjectName(w.name),kenrobot.getUserInfo(),kenrobot.trigger("util","message","打开成功")},function(e){kenrobot.trigger("util","message",{text:"打开失败",type:"error"})})}function a(e){var t=function(t){w.path?v.exportProject(e):e||!w.name?kenrobot.trigger("prompt","show",{title:"项目保存",placeholder:"项目名字",callback:function(t){t?(w.name=t,v.setProjectName(w.name),v.exportProject(e)):kenrobot.trigger("util","message",{text:"保存失败",type:"error"})}}):(w.name&&v.setProjectName(w.name),v.exportProject(e))};kenrobot.getUserInfo()||e||w.hasShowSave?t():(w.hasShowSave=!0,kenrobot.trigger("save","show",t))}function c(e,t){(t?kenrobot.postMessage("app:projectNewSaveAs",w.name,"scratch2",e):kenrobot.postMessage("app:projectNewSave",w.name,"scratch2",e,w.path)).then(function(e){(w=Object.assign(w,e)).name&&v.setProjectName(w.name),kenrobot.trigger("util","message","保存成功")},function(e){kenrobot.trigger("util","message",{text:"保存失败",type:"error"})})}function u(){var e=[{key:["ctrl+n","command+n"],callback:function(e){return s("new-project")}},{key:["ctrl+o","command+o"],callback:function(e){return s("open-project")}},{key:["ctrl+s","command+s"],callback:function(e){return s("save-project")}},{key:["ctrl+shift+s","command+shift+s"],callback:function(e){return s("save-as-project")}}];kenrobot.delayTrigger(100,"shortcut","register",e)}function s(e){switch(e){case"new-project":w={},v.newProject();break;case"open-project":r(arguments.length<=1?void 0:arguments[1]);break;case"save-project":a();break;case"save-as-project":a(!0);break;case"undelete":v.undelete();break;case"toggle-samll-stage":v.toggleSmallStage();break;case"toggle-turbo-mode":v.toggleTurboMode();break;case"edit-block-colors":v.editBlockColors()}}function i(e,t){if(N[t]){for(var o=arguments.length,n=Array(o>2?o-2:0),r=2;r<o;r++)n[r-2]=arguments[r];var a=N[t].concat(Array.from(n).map(function(e){return void 0!==j[e]?j[e]:e}));l.apply(this,a)}}function d(){kenrobot.trigger("serial","open")}function l(e){for(var t=arguments.length,o=Array(t>1?t-1:0),n=1;n<t;n++)o[n-1]=arguments[n];kenrobot.trigger("serial","sendPackage",[255,85,o.length+2,0,e].concat(o))}function k(e){D=e,v.onSerialPortReady()}function g(e,t){D&&D==e&&f(t)}function _(e){D&&D==e&&(D=null,kenrobot.trigger("util","message",{text:"串口已断开",type:"error"}),v.onSerialPortClose())}function f(e){L.length>30&&(L=[]);for(var t=0;t<e.length;t++)if(L.push(e[t]),!(L.length<2)&&(85==L[L.length-1]&&255==L[L.length-2]&&(P=!0,C=L.length-2),13==L[L.length-1]&&P)){P=!1;var o=C+4,n=L[o],r=L[++o];o++;var a;switch(r){case 1:a=L[o],o++;break;case 2:a=p(L,o),o+=4;break;case 3:a=T(L,o),o+=2;break;case 4:var c=L[o];a=h(L,++o,c),o+=c;break;case 5:a=E(L,o),o+=4;break;case 6:a=m(L,o),o+=4}U(n,r,a),L=[]}}function U(e,t,o){t>6||t<0?v.responseValue():e==y.TUDOU_IR?(o=o>0?o:65536+o,v.responseValue(o)):v.responseValue(o)}function b(e){var t=new DataView(new ArrayBuffer(e.length));return e.forEach(function(e,o){return t.setUint8(o,e)}),t}function p(e,t){return b(e.slice(t,t+4)).getFloat32(0,!0)}function E(e,t){return p(e,t)}function m(e,t){return b(e.slice(t,t+4)).getInt32(0,!0)}function T(e,t){return b(e.slice(t,t+2)).getInt16(0,!0)}function h(e,t,o){return e.slice(t,t+o).map(function(e){return String.fromCharCode(e)}).join("")}var O,v,D,R=function(){function e(e){if(!o&&("onreadystatechange"!==e.type||"complete"===document.readyState)){for(var n=0;n<t.length;n++)t[n].call(document);o=!0,t=null}}var t=[],o=!1;return document.addEventListener?(document.addEventListener("DOMContentLoaded",e,!1),document.addEventListener("readystatechange",e,!1),window.addEventListener("load",e,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",e),window.attachEvent("onload",e)),function(e){o?e.call(document):t.push(e)}}(),w={},y={TUDOU_MOVE:52,TUDOU_STOP:53,TUDOU_BATTERY:54,TUDOU_OBSTACLE:55,TUDOU_TRACKING:56,TUDOU_LED:57,TUDOU_BUZZER:58,TUDOU_IR:59,TUDOU_SERVO:60,TUDOU_RGBLED:61,KEDOU_MOVE:62,KEDOU_STOP:63,KEDOU_BATTERY:64,KEDOU_OBSTACLE:65,KEDOU_TRACKING:66,KEDOU_VOICE:67},S={GET:1,RUN:2,RESET:4,START:5},j={tudou_forward:1,tudou_back:2,tudou_turnLeft:3,tudou_turnRight:4,tudou_forwardLeft:1,tudou_forwardRight:2,tudou_backLeft:3,tudou_backRight:4,tudou_on:1,tudou_off:0,kedou_forward:1,kedou_back:2,kedou_turnLeft:3,kedou_turnRight:4,kedou_left:1,kedou_center:2,kedou_right:3,kedou_leftEdge:1,kedou_leftCenter:2,kedou_rightCenter:3,kedou_rightEdge:4,kedou_sound_1:1,kedou_sound_2:2,kedou_sound_3:3,kedou_sound_4:4},N={tudou_move:[S.RUN,y.TUDOU_MOVE],tudou_stop:[S.RUN,y.TUDOU_STOP],tudou_battery:[S.GET,y.TUDOU_BATTERY],tudou_obstacle:[S.GET,y.TUDOU_OBSTACLE],tudou_tracking:[S.GET,y.TUDOU_TRACKING],tudou_led:[S.RUN,y.TUDOU_LED],tudou_buzzer:[S.RUN,y.TUDOU_BUZZER],tudou_ir:[S.GET,y.TUDOU_IR],tudou_servo:[S.RUN,y.TUDOU_SERVO],tudou_rgbled:[S.RUN,y.TUDOU_RGBLED],kedou_move:[S.RUN,y.KEDOU_MOVE],kedou_stop:[S.RUN,y.KEDOU_STOP],kedou_battery:[S.GET,y.KEDOU_BATTERY],kedou_obstacle:[S.GET,y.KEDOU_OBSTACLE],kedou_tracking:[S.GET,y.KEDOU_TRACKING],kedou_sound:[S.RUN,y.KEDOU_VOICE]},L=[],P=!1,C=0;R(function(){window.kenrobot=window.kenrobot||top.kenrobot,v=document.getElementById("ken-scratch");var r=(O=document.querySelector(".player")).querySelector(".toolbar");window.JSeditorReady=o,kenrobot&&!kenrobot.isPC||r.remove(),kenrobot&&(kenrobot.isPC||(r.querySelector(".open").addEventListener("click",e),r.querySelector(".save").addEventListener("click",t)),kenrobot.view.callExt=i,kenrobot.view.openSerialPort=d,kenrobot.view.saveProject=c,kenrobot.viewType="scratch2",u(),kenrobot.on("app","command",s).on("project","open-by",n).on("serial","ready",k).on("serial","data",g).on("serial","close",_))})}();