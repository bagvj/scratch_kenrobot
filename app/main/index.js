"use strict";var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],r=!0,o=!1,i=void 0;try{for(var a,u=e[Symbol.iterator]();!(r=(a=u.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){o=!0,i=e}finally{try{!r&&u.return&&u.return()}finally{if(o)throw i}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")};!function i(a,u,s){function c(n,e){if(!u[n]){if(!a[n]){var t="function"==typeof require&&require;if(!e&&t)return t(n,!0);if(f)return f(n,!0);var r=new Error("Cannot find module '"+n+"'");throw r.code="MODULE_NOT_FOUND",r}var o=u[n]={exports:{}};a[n][0].call(o.exports,function(e){var t=a[n][1][e];return c(t||e)},o,o.exports,i,a,u,s)}return u[n].exports}for(var f="function"==typeof require&&require,e=0;e<s.length;e++)c(s[e]);return c}({1:[function(e,t,n){t.exports={SUCCESS:0,INVALID_PARAM:1,SYSTEM_ERROR:100,LOGIN_REQUIRED:200,PERMISSION_DENIED:201,INVALID_USER_TOKEN_SIGN:202,USER_TOKEN_EXPIRED:203,USER_NOT_EXITS:204,API_ERROR:300,INVALID_SSO_TICKET:301,INVALID_SSO_SESSION:302,INVALID_SSO_BROKER:303,INVLAID_SSO_SIGN:304}},{}],2:[function(e,t,n){t.exports={CHECK_UPDATE:"http://www.kenrobot.com/downloads/checkupdate",REPORT:"http://server.kenrobot.com/statistics/report",REGISTER:"http://server.kenrobot.com/register",FIND_PASSWORD:"http://server.kenrobot.com/password/email",LOGIN:"http://server.kenrobot.com/api/auth/login",LOGOUT:"http://server.kenrobot.com/api/auth/logout",WEIXIN_QRCODE:"http://server.kenrobot.com/api/auth/weixin/token",WEIXIN_LOGIN:"http://server.kenrobot.com/api/auth/weixin/login",VERIFY:"http://server.kenrobot.com/api/auth/verify",PACKAGE:"http://www.kenrobot.com/packages/packages.json",PROJECT_SYNC_LIST:"http://server.kenrobot.com/api/project/sync/list",PROJECT_SYNC_CREATE:"http://server.kenrobot.com/api/project/sync/create",PROJECT_SYNC_DELETE:"http://server.kenrobot.com/api/project/sync/delete",PROJECT_SYNC_UPLOAD:"http://server.kenrobot.com/api/project/sync/upload",PROJECT_SYNC_DOWNLOAD:"http://server.kenrobot.com/api/project/sync/download",PROJECT_SYNC_ITEM:"http://server.kenrobot.com/api/project/sync/item"}},{}],3:[function(e,t,n){var i,a,u,s,r,c,o=e("electron"),f=o.app,p=o.BrowserWindow,l=(o.dialog,o.ipcMain,o.shell),d=o.clipboard,v=e("path"),m=e("querystring"),h=e("electron-is"),g=e("electron-debug"),j=e("electron-log"),x=e("q"),y=e("fs-extra"),w=e("command-line-args"),b=e("hasha"),S=e("lodash"),I=e("terminate"),P=e("./util/util"),_=e("./config/url"),E=(e("./model/token"),e("./model/project")),D=e("./model/user"),A=e("./util/cache"),O=e("express"),C=8776,T="http://localhost:"+C,R="config",N=P.listenMessage,k=[{name:"debug-brk",type:Number,defaultValue:!1},{name:"dev",alias:"d",type:Boolean,defaultValue:!1},{name:"devTool",alias:"t",type:Boolean,defaultValue:!1},{name:"fullscreen",alias:"f",type:Boolean,defaultValue:!1},{name:"maximize",alias:"m",type:Boolean,defaultValue:!1},{name:"project",alias:"p",type:E.check,defaultOption:!0}],F=w(k,{argv:process.argv.slice(1),partial:!0}),q=h.dev()&&F.dev,L=h.dev(),U={};function B(){j.debug("app ready"),q&&g({enabled:!0,showDevTools:!0}),F.project&&(s=F.project),J(),function(){if(L||a.version==P.getVersion())return;a.version=P.getVersion(),a.reportInstall=!1,!0,i.setItem(R,a)}(),function(){L||a.reportInstall||V(null,"installations").then(function(){a.reportInstall=!0,i.setItem(R,a)});V(null,"open")}()}function J(){u=new p({width:1200,height:720,minWidth:1200,minHeight:720,frame:!1,show:!1,webPreferences:{plugins:!0,webSecurity:!1}}),F.fullscreen?u.setFullScreen(!0):F.maximize&&u.maximize(),u.on("closed",function(){return u=null}).once("ready-to-show",function(){return u.show()}).on("enter-full-screen",function(){return P.postMessage("app:onFullscreenChange",!0)}).on("leave-full-screen",function(){return P.postMessage("app:onFullscreenChange",!1)}),u.webContents.on("will-navigate",function(e){return e.preventDefault()}),u.webContents.session.on("will-download",Y),u.loadURL(T),u.focus()}function M(e,t){e.preventDefault(),s=E.check(t),r&&W().then(function(e){P.postMessage("app:onLoadProject",e)},function(e){e&&j.info(e)})}function z(e){c||(e.preventDefault(),P.postMessage("app:onBeforeQuit"))}function G(e){return P.removeFile(v.join(P.getAppPath("appData"),"temp"),!0),!0}function V(t,n){var r=x.defer(),e=P.getAppInfo(),o={version:e.version,platform:e.platform,bit:e.appBit,ext:e.ext,branch:e.branch,feature:e.feature};return t=S.merge({},t,o),n=n||"log",P.request(_.REPORT,{method:"post",data:{data:JSON.stringify(t),type:n}}).then(function(){r.resolve()},function(e){j.info("report error: type: "+n+", "+JSON.stringify(t)),e&&j.info(e),r.reject(e)}),r.promise}function Y(e,n,t){var r=P.uuid(6),o=(U[r]=n).getURL(),i=o.lastIndexOf("#"),a=m.parse(o.substring(i+1));o=o.substring(0,i);var u=a.deferId,s=v.join(P.getAppPath("appData"),"download",n.getFilename());if(a.checksum&&y.existsSync(s)){i=a.checksum.indexOf(":");var c=a.checksum.substring(0,i).replace("-","").toLowerCase();if(a.checksum.substring(i+1)==b.fromFileSync(s,{algorithm:c}))return n.cancel(),j.debug("download cancel, "+o+" has cache"),void P.callDefer(u,!0,{path:s})}n.setSavePath(s);var f=n.getTotalBytes();n.on("updated",function(e,t){"interrupted"==t?(U[r]&&delete U[r],j.debug("download interrupted: "+o),P.callDefer(u,!1,{path:s})):"progressing"===t&&(n.isPaused()?(U[r]&&delete U[r],j.debug("download paused: "+o),P.callDefer(u,!1,{path:s})):P.callDefer(u,"notify",{taskId:r,path:s,totalSize:f,size:n.getReceivedBytes()}))}),n.once("done",function(e,t){U[r]&&delete U[r],"completed"==t?(j.debug("download success: "+o+", at "+s),P.callDefer(u,!0,{path:s})):(j.debug("download fail: "+o),P.callDefer(u,!1,{path:s}))})}function W(){if(r=!0,s){j.debug("loadOpenProject: "+s);var e=s;return s=null,E.read(e)}return P.rejectPromise()}!function(){process.on("uncaughtException",function(e){var t=e.stack||e.name+": "+e.message;j.info(t),f.quit()}),q?(j.transports.console.level="debug",j.transports.file.level="debug"):(j.transports.console=!1,j.transports.file.format="[{y}-{m}-{d} {h}:{i}:{s}] [{level}] {text}",j.transports.file.level="info"),n=P.getAppInfo(),r="26.0.0.131",o=h.windows()?"pepflashplayer"+n.appBit+".dll":h.macOS()?"PepperFlashPlayer.plugin":"libpepflashplayer.so",o=v.join(P.getAppPath("plugins"),"FlashPlayer",n.platform,o),j.info("initFlashPlugin: "+o+" version: "+r),f.commandLine.appendSwitch("ppapi-flash-path",o),f.commandLine.appendSwitch("ppapi-flash-version",r),e=v.join(__dirname,".."),t=O(),t.use("/",O.static(v.join(e,"renderer"))),t.listen(C),i=new A(R),a=i.getItem(R,{}),P.removeFile(v.join(P.getAppPath("appData"),"config.json"),!0),f.makeSingleInstance(function(e,t){if(u){u.isMinimized()&&u.restore(),u.focus();var n=w(k,{argv:e.slice(1),partial:!0});n.project&&(s=n.project),j.debug("app second run"),W().then(function(e){P.postMessage("app:onLoadProject",e)},function(e){e&&j.info(e)})}})&&f.quit();var e,t;var n,r,o;f.on("ready",B).on("window-all-closed",function(){return"darwin"!==process.platform&&f.quit()}).on("activate",function(){return null===u&&J()}).on("before-quit",z).on("will-quit",G).on("quit",function(){return j.debug("app quit")}),h.macOS()&&f.on("open-file",M),function(){N("getAppInfo",function(){return P.resolvePromise(P.getAppInfo())}),N("getBaseUrl",function(e){return P.resolvePromise(T)}),N("execFile",function(e){return P.execFile(e)}),N("execCommand",function(e,t){return P.execCommand(e,t)}),N("spawnCommand",function(e,t,n){return P.spawnCommand(e,t,n)}),N("readFile",function(e,t){return P.readFile(e,t)}),N("writeFile",function(e,t){return P.writeFile(e,t)}),N("saveFile",function(e,t,n){return P.saveFile(e,t,n)}),N("moveFile",function(e,t,n){return P.moveFile(e,t,n)}),N("removeFile",function(e){return P.removeFile(e)}),N("searchFiles",function(e){return P.searchFiles(e)}),N("readJson",function(e,t){return P.readJson(e,t)}),N("writeJson",function(e,t,n,r){return P.writeJson(e,t,n,r)}),N("showOpenDialog",function(e){return P.showOpenDialog(e)}),N("showSaveDialog",function(e){return P.showSaveDialog(e)}),N("request",function(e,t,n){return P.request(e,t,n)}),N("showItemInFolder",function(e){return P.resolvePromise(l.showItemInFolder(v.normalize(e)))}),N("openUrl",function(e){return P.resolvePromise(e&&l.openExternal(e))}),N("buildProject",function(e,t){return buildProject(e,t)}),N("uploadFirmware",function(e,t,n){return uploadFirmware(e,t,n)}),N("download",function(e,t){return function(e,t){var n=x.defer(),r=P.getDefer(),o=r.deferId,i=r.promise;t.deferId=o;var a=m.stringify(t);return j.debug("download "+e+", options: "+a),i.then(function(e){n.resolve(e)},function(e){e&&j.info(e),n.reject(e)},function(e){n.notify(e)}),u.webContents.downloadURL(e+"#"+a),n.promise}(e,t)}),N("cancelDownload",function(e){var t;(t=U[e])&&t.cancel()}),N("checkUpdate",function(){return t=x.defer(),e=P.getAppInfo(),n=e.feature?e.feature+","+e.arch:e.arch,r=_.CHECK_UPDATE+"?appname="+e.name+"&release_version="+e.branch+"&version="+e.version+"&platform="+e.platform+"&ext="+e.ext+"&features="+n,j.debug("checkUpdate: "+r),P.request(r).then(function(e){t.resolve(e)},function(e){e&&j.info(e),t.reject(e)}),t.promise;var t,e,n,r}),N("removeOldVersions",function(e){return r=e,t=x.defer(),n=P.getAppInfo(),o=v.join(P.getAppPath("appData"),"download"),P.searchFiles(o+"/"+n.name+"-*."+n.ext).then(function(e){var n=/\d+\.\d+\.\d+/;e.map(function(e){return v.basename(e)}).filter(function(e){var t=e.match(n);return!!t&&P.versionCompare(t[0],r)<0}).forEach(function(e){P.removeFile(v.join(o,e),!0)}),t.resolve()},function(e){e&&j.info(e),t.reject(e)}),t.promise;var r,t,n,o}),N("reportToServer",function(e,t){return V(e,t)}),N("loadToken",function(){return D.loadToken()}),N("login",function(e,t){return D.login(e,t)}),N("logout",function(){return D.logout()}),N("weixinLogin",function(e){return D.weixinLogin(e)}),N("weixinQrcode",function(){return D.weixinQrcode()}),N("register",function(e){return D.register(e)}),N("resetPassword",function(e){return D.resetPassword(e)}),N("setCache",function(e,t){return e!==R?i.setItem(e,t):P.rejectPromise()}),N("getCache",function(e,t){return e!==R?P.resolvePromise(i.getItem(e,t)):P.rejectPromise()}),N("loadOpenOrRecentProject",function(){return t=x.defer(),W().then(function(e){t.resolve(e)},function(){var e=i.getItem("recentProject");e?E.read(e).then(function(e){t.resolve(e)},function(e){t.reject(e)}):P.rejectPromise(null,t)}),t.promise;var t}),N("projectRead",function(e){return E.read(e)}),N("projectOpen",function(e){return E.open(e)}),N("projectSave",function(e,t,n){return E.save(e,t,n)}),N("projectSaveAs",function(e,t,n){return E.saveAs(e,t,n)}),N("projectSync",function(){return E.sync()}),N("projectList",function(){return E.list()}),L&&(N("projectCreate",function(e){return E.create(e)}),N("projectUpload",function(e,t){return E.upload(e,t)}),N("projectDelete",function(e,t){return E.remove(e,t)}),N("projectDownload",function(e,t){return E.download(e,t)}));N("log",function(e,t){return(j[t]||j.debug).bind(j).call(e)}),N("copy",function(e,t){return d.writeText(e,t)}),N("quit",function(){return f.quit()}),N("exit",function(){return(c=!0)&&G()&&I(process.pid)}),N("reload",function(){return u.reload()}),N("relaunch",function(){return f.relaunch({args:process.argv.slice(1).concat(["--relaunch"])}),void f.exit(0)}),N("fullscreen",function(){return u.setFullScreen(!u.isFullScreen())}),N("min",function(){return u.minimize()}),N("max",function(){u.isFullScreen()?u.setFullScreen(!1):u.isMaximized()?u.unmaximize():u.maximize()}),N("errorReport",function(e,t){return n=e,r=t,void j.info(r+": "+n);var n,r})}(),j.debug("app "+f.getName()+" start, version "+P.getVersion())}()},{"./config/url":2,"./model/project":4,"./model/token":5,"./model/user":6,"./util/cache":7,"./util/util":8,"command-line-args":void 0,electron:void 0,"electron-debug":void 0,"electron-is":void 0,"electron-log":void 0,express:void 0,"fs-extra":void 0,hasha:void 0,lodash:void 0,path:void 0,q:void 0,querystring:void 0,terminate:void 0}],4:[function(e,t,n){var m=e("path"),s=e("fs-extra"),h=e("q"),r=e("hasha"),g=e("electron-log"),j=e("../util/util"),c=e("./token"),f=e("../config/url"),x=".kbl",o="kblock",p=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"],l=96,i=j.throttle(d,3e3);function y(e){return e&&m.extname(e)==x&&s.existsSync(e)?e:null}function a(e){var t,n=h.defer();if(y(e))t=e;else{var r=m.basename(e);if(t=m.join(e,r+x),s.existsSync(t)||(t=m.join(e,"project.json")),!s.existsSync(t))return j.rejectPromise(null,n)}return j.readJson(t).then(function(e){n.resolve({path:m.dirname(t),project_type:e.project_type||"local",data:e})},function(e){e&&g.info(e),n.reject(e)}),n.promise}function u(e,n,t,r){var o,i,a,u,s=h.defer(),c=function(e,t){I(e,t,n).then(function(){s.resolve({project_name:n.project_name,project_type:n.project_type,updated_at:n.updated_at,path:e})},function(e){e&&g.info(e),s.reject(e)})};return t?(r=m.join(j.getAppPath("temp"),"build","sketch_"+j.stamp()),c(r,m.basename(r))):r?c(m.join(m.dirname(r),e),e):j.showSaveDialog({defaultPath:(o=new Date,i=p[o.getMonth()],a=(100+o.getDate()).toString().substring(1),l++,u=String.fromCharCode(l<=122?l:l=97),"sketch_"+i+a+u)}).then(function(e){c(e,m.basename(e))},function(e){e&&g.info(e),s.reject(e)}),s.promise}function d(){var n=h.defer();return g.debug("project sync"),h.all([v(),P()]).then(function(e){var t=_slicedToArray(e,2);(function(e,t){var a=h.defer(),n=function(e,t){var n={},r={};e.forEach(function(e){n[""+e.name]=e}),t.forEach(function(e){r[""+e.name]=e});var o=[],i=[],a=[];return e.forEach(function(e){var t=r[e.name];!t||!t.modify_time||t.modify_time<e.modify_time?o.push(e):y(m.join(A(),e.name,e.name+x))||o.push(e)}),t.forEach(function(e){var t=n[e.name];t?t.modify_time<e.modify_time&&i.push(e):(a.push(e),i.push(e))}),[a,o,i]}(e,t),r=_slicedToArray(n,3),u=r[0],o=r[1],s=r[2];g.debug("doSync: createList:"+u.length+", downloadList:"+o.length+", uploadList:"+s.length);var i=u.length+o.length+s.length,c=0,f=function(e,t){c++,a.notify({total:i,count:c,name:e,action:t})};return(p=o,l=f,v=h.defer(),(d=function(){if(0==p.length)return j.resolvePromise(!0,v);var e=p.shift();S(e.name,e.hash).then(function(){l(e.name,"download"),0==p.length?v.resolve():setTimeout(function(){return d()},100)},function(e){e&&g.info(e),v.reject(e)})})(),v.promise).then(function(){var n,r,o,i;(n=u,r=f,i=h.defer(),(o=function(){if(0==n.length)return j.resolvePromise(!0,i);var t=n.shift();w(t.name).then(function(e){t.hash=e.hash,r(t.name,"create"),0==n.length?i.resolve():setTimeout(function(){return o()},100)},function(e){e&&g.info(e),i.reject(e)})})(),i.promise).then(function(){var t,n,r,o;(t=s,n=f,o=h.defer(),(r=function(){if(0==t.length)return j.resolvePromise(!0,o);var e=t.shift();b(e.name,e.hash).then(function(){n(e.name,"upload"),0==t.length?o.resolve():setTimeout(function(){return r()},100)},function(e){e&&g.info(e),o.reject(e)})})(),o.promise).then(function(){a.resolve()},function(e){e&&g.info(e),a.reject(e)})},function(e){e&&g.info(e),a.reject(e)})},function(e){e&&g.info(e),a.reject(e)}),a.promise;var p,l,d,v})(t[0],t[1]).then(function(){g.debug("project sync success"),n.resolve()},function(e){g.debug("project sync fail"),e&&g.info(e),n.reject(e)},function(e){n.notify(e)})},function(e){e&&g.info(e),n.reject(e)}),n.promise}function v(){var t=h.defer();return g.debug("project list"),c.request(f.PROJECT_SYNC_LIST,{method:"post"}).then(function(e){0==e.status?t.resolve(e.data.filter(function(e){return e.type==o})):t.reject(e.message)},function(e){e&&g.info(e),t.reject(e)}),t.promise}function w(n){var r=h.defer();return g.debug("project create: "+n),c.request(f.PROJECT_SYNC_CREATE,{method:"post",data:{name:n,type:o}}).then(function(e){if(0==e.status){var t=e.data;E(t.name,t.modify_time,t.hash).then(function(){g.debug("project create success: "+n+" "+t.hash),r.resolve(t)},function(e){e&&g.info(e),r.reject(e)})}else r.reject(e.message)},function(e){e&&g.info(e),r.reject(e)}),r.promise}function b(n,r){var e,t,o,i,a,u=h.defer();return g.debug("project upload: "+n+": "+r),(e=A(),t=n,o=h.defer(),i=m.join(j.getAppPath("appData"),"temp",j.uuid(6)+".7z"),a=[t+"/"+t+x],j.compress(e,a,i).then(function(){o.resolve(i)},function(e){e&&g.info(e),o.reject(e)}),o.promise).then(function(e){var t=f.PROJECT_SYNC_UPLOAD+"/"+r;c.request(t,{method:"post",body:s.createReadStream(e)}).then(function(e){if(0==e.status){var t=e.data;E(n,t.modify_time,r).then(function(){g.debug("project upload success: "+n),u.resolve(t)},function(e){e&&g.info(e),u.reject(e)})}else u.reject(e.message)},function(e){e&&g.info(e),u.reject(e)})},function(e){e&&g.info(e),u.reject(e)}),u.promise}function S(r,o){var i=h.defer();g.debug("project download: "+o);var e=f.PROJECT_SYNC_DOWNLOAD+"/"+o;return c.request(e,{method:"post"},!1).then(function(e){var t=m.join(j.getAppPath("appData"),"temp",j.uuid(6)+".7z");s.ensureDirSync(m.dirname(t));var n=s.createWriteStream(t);e.body.pipe(n),e.body.on("end",function(){j.uncompress(t,A()).then(function(){E(r,null,o).then(function(){g.debug("project download success: "+r),i.resolve()},function(e){e&&g.info(e),i.reject(e)})},function(e){e&&g.info(e),i.reject(e)})}).on("error",function(e){e&&g.info(e),i.reject(e)})},function(e){e&&g.info(e),i.reject(e)}),i.promise}function I(e,t,n,r){n.project_name=t,n.project_type=r||"local",n.updated_at=new Date;var o=m.join(e,t+x);return g.debug("project save: "+o),h.all([j.writeJson(o,n),j.removeFile(m.join(e,t+".ino")),j.removeFile(m.join(e,"project.json"))])}function P(){var e=h.defer();if(!c.getUser())return j.rejectPromise(null,e);var t=D();return s.existsSync(t)?j.readJson(t):j.resolvePromise([],e)}function _(e){return c.getUser()?j.writeJson(D(),e):j.rejectPromise()}function E(n,r,o){var i=h.defer();return r=r||j.stamp(),P().then(function(e){var t=e.find(function(e){return o&&e.hash==o||e.name==n});t?(n&&(t.name=n),o&&(t.hash=o),t.modify_time=r):e.push({name:n,hash:o,modify_time:r}),_(e).then(function(){i.resolve()},function(e){e&&g.info(e),i.reject(e)})},function(e){e&&g.info(e),i.reject(e)}),i.promise}function D(){var e=c.getUserId();return e?m.join(j.getAppPath("appData"),"projects",O(e,1),"list.json"):null}function A(){var e=c.getUserId();return e?m.join(j.getAppPath("appDocuments"),"projects",O(e)):null}function O(e,t){return t=t||0,r(""+e,{algorithm:"md5"}).substring(8*t,8*(t+1))}t.exports.check=y,t.exports.read=a,t.exports.open=function(e){var t=h.defer(),n=function(e){a(e).then(function(e){t.resolve(e)},function(e){e&&g.info(e),t.reject(e)})};if(e)return c.getUser()?(n(m.join(A(),e)),t.promise):j.rejectPromise(null,t);var r={};return r.defaultPath=c.getUser()?A():j.getAppPath("documents"),r.properties=["openDirectory"],j.showOpenDialog(r).then(function(e){n(e)},function(e){e&&g.info(e),t.reject(e)}),t.promise},t.exports.save=function(e,t,n){var r=h.defer();if(!c.getUser()){var o=m.join(j.getAppPath("appDocuments"),"projects");return n&&n.startsWith(o)&&(n=null),u(e,t,!1,n)}return I(n=m.join(A(),e),e,t,"cloud").then(function(){E(e).then(function(){i(),r.resolve({project_name:t.project_name,project_type:t.project_type,updated_at:t.updated_at,path:n})},function(e){e&&g.info(e),r.reject(e)})},function(e){e&&g.info(e),r.reject(e)}),r.promise},t.exports.saveAs=u,t.exports.sync=d,t.exports.list=v,t.exports.create=w,t.exports.remove=function(t,o){var i=h.defer();return g.debug("project remove: "+o),c.request(f.PROJECT_SYNC_DELETE,{method:"post",data:{hash:o}}).then(function(e){var n,r;0==e.status?h.all([j.removeFile(m.join(A(),t)),(n=o,r=h.defer(),P().then(function(e){var t=e.findIndex(function(e){return e.hash==n});t<0?r.resolve():(e.splice(t,1),_(e).then(function(){r.resolve()},function(e){e&&g.info(e),r.reject(e)}))},function(e){e&&g.info(e),r.reject(e)}),r.promise)]).then(function(){g.debug("project remove success: "+t),i.resolve()},function(e){e&&g.info(e),i.reject(e)}):i.reject(e.message)},function(e){e&&g.info(e),i.reject(e)}),i.promise},t.exports.upload=b,t.exports.download=S},{"../config/url":2,"../util/util":8,"./token":5,"electron-log":void 0,"fs-extra":void 0,hasha:void 0,path:void 0,q:void 0}],5:[function(e,t,n){e("path");var r,i,o=e("crypto"),a=e("q"),u=(e("fs-extra"),e("electron-log")),s=e("is-online"),c=e("../util/util"),f=e("../config/url"),p=e("../config/status"),l=e("../util/cache");function d(){i=null,m().removeItem("key",!1),m().removeItem("value",!1),m().save()}function v(e,t,n){if(!i)return c.rejectPromise();var r=c.getAppInfo(),o=t.headers||{};return o.Authorization="Bearer "+i.api_token,o["X-Ken-App-Version"]=r.name+"-"+r.version+"-"+r.branch+"-"+r.platform+"-"+r.appBit,t.headers=o,c.request(e,t,n)}function m(){return r||(r=new l("token")),r}t.exports.getUser=function(){return i&&i.user?i.user:null},t.exports.getUserId=function(){return i&&i.user?i.user.id:0},t.exports.load=function(){var t,n=a.defer(),e=m().getItem("key"),r=m().getItem("value");if(!e||!r)return c.rejectPromise(null,n);try{var o=c.decrypt(r,Buffer.from(e,"hex"));i=JSON.parse(o),(t=a.defer(),v(f.VERIFY,{method:"post"}).then(function(e){e.status==p.SUCCESS?t.resolve():t.reject(e.message)},function(e){e&&u.info(e),t.reject(e)}),t.promise).then(function(){n.resolve(i)},function(e){s().then(function(){return d()}).fin(function(){e&&u.info(e),n.reject(e)})})}catch(e){n.reject()}return n.promise},t.exports.save=function(e){try{var t=o.randomBytes(128);return m().setItem("key",t.toString("hex"),!1),m().setItem("value",c.encrypt(JSON.stringify(e),t),!1),m().save(),i=e,c.resolvePromise()}catch(e){return c.rejectPromise(e)}},t.exports.remove=d,t.exports.request=v},{"../config/status":1,"../config/url":2,"../util/cache":7,"../util/util":8,crypto:void 0,"electron-log":void 0,"fs-extra":void 0,"is-online":void 0,path:void 0,q:void 0}],6:[function(e,t,n){var i=e("q"),a=e("electron-log"),u=e("../util/util"),s=e("./token"),c=e("../config/url"),f=(e("../config/status"),/^([a-zA-Z0-9]+[_|\-|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\-|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/);t.exports.loadToken=function(){var t=i.defer();return s.load().then(function(e){t.resolve(e.user)},function(e){e&&a.info(er),t.reject(e)}),t.promise},t.exports.login=function(e,t,n){var r=i.defer(),o={};return f.test(e)?o.email=e:o.username=e,o.password=t,u.request(c.LOGIN,{method:"POST",data:o}).then(function(e){0==e.status?s.save(e.data).fin(function(){r.resolve(e)}):r.resolve(e)},function(e){e&&a.info(er),r.reject(e)}),r.promise},t.exports.logout=function(){var t=i.defer();return s.remove(),u.request(c.LOGOUT).then(function(){t.resolve()},function(e){e&&a.info(e),t.reject(e)}),t.promise},t.exports.weixinLogin=function(e){var t=i.defer();return u.request(c.WEIXIN_LOGIN,{method:"POST",data:{auth_key:e}}).then(function(e){0==e.status||1==e.status?s.save(e.data).fin(function(){t.resolve(e)}):t.resolve(e)},function(e){e&&a.info(e),t.reject(e)}),t.promise},t.exports.weixinQrcode=function(){var t=i.defer();return u.request(c.WEIXIN_QRCODE).then(function(e){t.resolve(e)},function(e){e&&a.info(e),t.reject(e)}),t.promise},t.exports.register=function(e){var t=i.defer();return u.request(c.REGISTER,{method:"POST",data:{email:e.email,username:e.username,password:e.password,login:!0}}).then(function(e){t.resolve(e)},function(e){e&&a.info(e),t.reject(e)}),t.promise},t.exports.resetPassword=function(e){var t=i.defer();return u.request(c.FIND_PASSWORD,{method:"POST",data:{email:e}}).then(function(e){t.resolve(e)},function(e){e&&a.info(e),t.reject(e)}),t.promise}},{"../config/status":1,"../config/url":2,"../util/util":8,"./token":5,"electron-log":void 0,q:void 0}],7:[function(e,t,n){e("path"),e("crypto"),e("q"),e("fs-extra"),e("electron-log");var r=e("flat-cache"),o=e("./util"),i={};function a(e){if(i[e])return i[e];this.name=e,this._cache=r.load(e,o.getAppPath("appData")),i[e]=this}a.prototype.getItem=function(e,t){var n=this._cache.getKey(e);return void 0!==n?n:t},a.prototype.setItem=function(e,t,n){n=!1!==n,this._cache.setKey(e,t),n&&this._cache.save(!0)},a.prototype.removeItem=function(e,t){t=!1!==t,this._cache.removeKey(e),t&&this._cache.save(!0)},a.prototype.save=function(){this._cache.save(!0)},t.exports=a},{"./util":8,crypto:void 0,"electron-log":void 0,"flat-cache":void 0,"fs-extra":void 0,path:void 0,q:void 0}],8:[function(e,t,n){var r=e("os"),u=e("child_process"),o=e("path"),i=e("crypto"),a=e("electron"),s=a.app,c=a.ipcMain,f=a.dialog,p=a.BrowserWindow,l=e("electron-log"),d=e("electron-is"),v=e("q"),m=e("fs-extra"),h=e("globby"),g=e("sudo-prompt"),j=e("iconv-lite"),x=(e("lodash"),e("7zip-bin").path7za.replace("app.asar","app.asar.unpacked")),y=e("node-fetch"),w=e(d.dev()?o.resolve("app","package.json"):o.resolve(__dirname,"..","package.json")),b="-----BEGIN PUBLIC KEY-----\nMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC7Jat1/19NDxOObrFpW8USTia6\nuHt34Sac1Arm6F2QUzsdUEUmvGyLIOIGcdb+F6pTdx4ftY+wZi7Aomp4k3vNqXmX\nT0mE0vpQlCmsPUcMHXuUi93XTGPxLXIv9NXxCJZXSYI0JeyuhT9/ithrYlbMlyNc\nwKB/BwSpp+Py2MTT2wIDAQAB\n-----END PUBLIC KEY-----\n";d.dev()&&s.setName(w.productName);var S={},I=0;function P(){return d.windows()?"win":d.macOS()?"mac":0<=r.arch().indexOf("arm")?"arm":"linux"}function _(){return d.dev()?w.version:s.getVersion()}function E(e,t){switch(e){case"appData":return o.join(s.getPath("appData"),s.getName());case"appResource":return d.dev()?o.resolve("data"):o.resolve(s.getAppPath(),"..","..","data");case"appDocuments":return o.join(s.getPath("documents"),s.getName());case"script":return o.join(E("appResource"),"scripts",t+"."+(d.windows()?"bat":"sh"));case"driver":return o.join(E("appResource"),"driver");case"plugins":return o.join(E("appResource"),"plugins");case"command":return o.join(E("appData"),"temp",""+D(6));case"libraries":return o.join(E("appDocuments"),"libraries");case"packages":return o.join(E("appDocuments"),"packages");case"arduino":return o.join(E("appResource"),"arduino-"+P());default:return s.getPath(e)}}function D(e,t){var n,r,o="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),i=[];if(t=t||o.length,e)for(n=0;n<e;n++)i[n]=o[0|Math.random()*t];else for(i[8]=i[13]=i[18]=i[23]="-",i[14]="4",n=0;n<36;n++)i[n]||(r=0|16*Math.random(),i[n]=o[19==n?3&r|8:r]);return i.join("")}function A(){return parseInt(Date.now()/1e3)}function O(e,t){return t=t||v.defer(),setTimeout(function(){return t.resolve(e)},10),t.promise}function C(e,t,n){var r=v.defer();return t=t||{},n=n||!1,l.debug("execCommand:"+e+", options: "+JSON.stringify(t)+", useSudo: "+n),n?g.exec(e,{name:"kenrobot"},function(e,t,n){if(t=t||"",n=n||"",t=d.windows()?j.decode(Buffer.from(t),"win1252"):t,n=d.windows()?j.decode(Buffer.from(n),"win1252"):n,e)return l.info(e),t&&l.info(t),n&&l.info(n),void r.reject(e||n||t);d.dev()&&t&&l.debug(t),r.resolve(t)}):u.exec(e,t,function(e,t,n){if(t=t||"",n=n||"",t=d.windows()?j.decode(Buffer.from(t),"win1252"):t,n=d.windows()?j.decode(Buffer.from(n),"win1252"):n,e)return l.info(e),t&&l.info(t),n&&l.info(n),void r.reject(e||n||t);d.dev()&&t&&l.debug(t),r.resolve(t)}),r.promise}function T(e,t,n){var r=v.defer(),o=u.spawn(e,t,n),i="",a="";return o.stdout.on("data",function(e){var t=d.windows()?j.decode(e,"win1252"):e.toString();d.dev()&&t&&l.debug(t),i+=t,r.notify({type:"stdout",data:t})}),o.stderr.on("data",function(e){var t=d.windows()?j.decode(e,"win1252"):e.toString();d.dev()&&t&&l.debug(t),a+=t,r.notify({type:"stderr",data:t})}),o.on("close",function(e){0==e?r.resolve(i):r.reject(a)}),r.promise}function R(e,t,n,r){if(!r){var o=v.defer();return m.outputFile(e,t,n,function(e){if(e)return l.info(e),void o.reject(e);o.resolve()}),o.promise}m.outputFileSync(e,t,n)}function N(e,t){var n=v.defer();return(e=e||{}).title="保存",e.defaultPath=e.defaultPath&&o.isAbsolute(e.defaultPath)?e.defaultPath:o.join(E("documents"),e.defaultPath||"untitled"),e.buttonLabel="保存",t=t||p.getAllWindows()[0],f.showSaveDialog(t,e,function(e){e?n.resolve(e):n.reject()}),n.promise}t.exports.getPlatform=P,t.exports.getVersion=_,t.exports.getAppInfo=function(){var e={bit:"x64"===process.arch||process.env.hasOwnProperty("PROCESSOR_ARCHITEW6432")?64:32,arch:process.arch,platform:P(),version:_(),name:s.getName(),buildNumber:w.buildNumber,dev:d.dev()};return d.dev()?(e.ext=o.extname(E("exe")).replace(".",""),e.branch="beta",e.feature="",e.date=A(),e.appBit=e.bit):(e.ext=w.buildInfo.ext,e.branch=w.buildInfo.branch,e.feature=w.buildInfo.feature,e.date=w.buildInfo.date,e.appBit=w.buildInfo.appBit),e},t.exports.getAppPath=E,t.exports.getExpire=function(){return!d.dev()&&w.buildInfo.expire},t.exports.formatDate=function(e,t){"number"==typeof e?e=new Date(e):e||(e=new Date);var n={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours()%12==0?12:e.getHours()%12,"H+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length))),/(E+)/.test(t)&&(t=t.replace(RegExp.$1,(1<RegExp.$1.length?2<RegExp.$1.length?"星期":"周":"")+["日","一","二","三","四","五","六"][e.getDay()]));for(var r in n)new RegExp("("+r+")").test(t)&&(t=t.replace(RegExp.$1,1===RegExp.$1.length?n[r]:("00"+n[r]).substr((""+n[r]).length)));return t},t.exports.versionCompare=function(e,t){for(var n=/(\d+)\.(\d+)\.(\d+)/,r=n.exec(e),o=n.exec(t),i=[parseInt(r[1]),parseInt(r[2]),parseInt(r[3])],a=[parseInt(o[1]),parseInt(o[2]),parseInt(o[3])],u=0;u<=2;u++)if(i[u]!=a[u])return a[u]<i[u]?1:-1;return 0},t.exports.postMessage=function(e){for(var t=arguments.length,n=Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];l.debug("postMessage: "+e+", "+n.join(", "));var o=p.getAllWindows();o&&o.length&&o[0].webContents.send(e,n)},t.exports.listenMessage=function(e,i){var a=this,u="app:"+e;c.on(u,function(t,n){for(var e=arguments.length,r=Array(2<e?e-2:0),o=2;o<e;o++)r[o-2]=arguments[o];(i.apply(a,r)||O()).then(function(e){t.sender.send(u,n,!0,e)},function(e){t.sender.send(u,n,!1,e)},function(e){t.sender.send(u,n,"notify",e)})})},t.exports.getDefer=function(){var e=v.defer(),t=I++;return{deferId:t,promise:(S[t]=e).promise}},t.exports.callDefer=function(e,t){var n=S[e];if(n){var r;"notify"===t?r=n.notify:(delete S[e],r=t?n.resolve:n.reject);for(var o=arguments.length,i=Array(2<o?o-2:0),a=2;a<o;a++)i[a-2]=arguments[a];r.apply(this,i)}},t.exports.handleQuotes=function(e){return d.windows()?e:e.replace(/"/g,"")},t.exports.uuid=D,t.exports.stamp=A,t.exports.throttle=function(e,t){var n;return function(){n&&clearTimeout(n),n=setTimeout(function(){e(),clearTimeout(n),n=null},t)}},t.exports.encrypt=function(e,t,n){n=n||"aes-128-cbc";var r=i.createCipher(n,t),o=r.update(e,"utf8","binary");return o+=r.final("binary"),o=new Buffer(o,"binary").toString("base64")},t.exports.decrypt=function(e,t,n){n=n||"aes-128-cbc",e=new Buffer(e,"base64").toString("binary");var r=i.createDecipher(n,t),o=r.update(e,"binary","utf8");return o+=r.final("utf8")},t.exports.rsa_encrypt=function(e,t){t=t||b;var n=new Buffer(e);return i.publicEncrypt({key:t,padding:i.constants.RSA_PKCS1_PADDING},n).toString("base64")},t.exports.rsa_decrypt=function(e,t){var n=new Buffer(e,"base64");return i.privateDecrypt({key:t,padding:i.constants.RSA_PKCS1_PADDING},n).toString("utf8")},t.exports.resolvePromise=O,t.exports.rejectPromise=function(e,t){return t=t||v.defer(),setTimeout(function(){return t.reject(e)},10),t.promise},t.exports.execFile=function(e,t){return l.debug("execFile: "+e),C(d.windows()?"start /WAIT "+e:""+e,null,t)},t.exports.execCommand=C,t.exports.spawnCommand=T,t.exports.readFile=function(e,t,n){if(n)return m.readFileSync(e,t);var r=v.defer();return t=t||"utf8",m.readFile(e,t,function(e,t){if(e)return l.info(e),void r.reject(e);r.resolve(t)}),r.promise},t.exports.writeFile=R,t.exports.saveFile=function(e,t,n){var r=v.defer();return n=n||{},e&&(n.defaultPath=e),N(n).then(function(e){R(e,t,n).then(function(){r.resolve()},function(e){e&&l.info(e),r.reject(e)})},function(e){e&&l.info(e),r.reject(e)}),r.promise},t.exports.moveFile=function(e,t,n){var r=v.defer();return n=n||{overwrite:!0},m.move(e,t,n,function(e){if(e)return l.info(e),void r.reject(e);r.resolve()}),r.promise},t.exports.removeFile=function(e,t){if(!t){var n=v.defer();return m.remove(e,function(e){if(e)return l.info(e),void n.reject(e);n.resolve()}),n.promise}m.removeSync(e)},t.exports.readJson=function(e,t){var n=v.defer();return t=t||{},m.readJson(e,t,function(e,t){if(e)return l.info(e),void n.reject(e);n.resolve(t)}),n.promise},t.exports.writeJson=function(e,t,n,r){if(!r){var o=v.defer();return n=n||{},m.outputJson(e,t,n,function(e){if(e)return l.info(e),void o.reject(e);o.resolve()}),o.promise}m.outputJsonSync(e,t,n)},t.exports.searchFiles=function(e){var t=v.defer();return l.debug("searchFiles: "+e),h(e).then(function(e){t.resolve(e)},function(e){e&&l.info(e),t.reject(e)}),t.promise},t.exports.compress=function(e,t,n,r){var o=v.defer();return t=t||[t],r=r||"7z",l.debug("compress: "+e+": "+t.length+" => "+n+": "+r),C("cd "+(d.windows()?"/d ":"")+e+' && "'+x+'" a -t'+r+' -r "'+n+'" '+t.join(" ")).then(function(){o.resolve()},function(e){e&&l.info(e),o.reject(e)}),o.promise},t.exports.uncompress=function(e,t,n){var r=v.defer(),o=/([\d]+)% \d+ - .*\r?/g;return l.debug("uncompress: "+e+" => "+t),n?T('"'+x+'"',["x",'"'+e+'"',"-bsp1","-y",'-o"'+t+'"'],{shell:!0}).then(function(e){r.resolve(e)},function(e){e&&l.info(e),r.reject(e)},function(e){if(o.lastIndex=0,o.test(e.data)){for(var t,n=o.exec(e.data);t=n,n=o.exec(e.data););r.notify(parseInt(t[1]))}}):C('"'+x+'" x "'+e+'" -y -o"'+t+'"').then(function(){r.resolve()},function(e){e&&l.info(e),r.reject(e)}),r.promise},t.exports.showOpenDialog=function(e,t){var n=v.defer();return(e=e||{}).title="打开",e.defaultPath=e.defaultPath||E("documents"),e.buttonLabel="打开",t=t||p.getAllWindows()[0],f.showOpenDialog(t,e,function(e){e?n.resolve(e[0]):n.reject()}),n.promise},t.exports.showSaveDialog=N,t.exports.request=function(e,t,n){var r=v.defer();if(n=!1!==n,(t=t||{}).method=t.method||"GET",n&&t.data){t.body=JSON.stringify(t.data);var o=t.headers||(t.headers={});o["Content-Type"]="application/json",o.Accept="application/json",delete t.data}return y(e,t).then(function(e){if(e.ok)return n?e.json():e;var t=new Error(e.statusText);throw t.status=e.status,t}).then(function(e){r.resolve(e)}).catch(function(e){e&&l.info(e),r.reject(e)}),r.promise}},{"7zip-bin":void 0,child_process:void 0,crypto:void 0,electron:void 0,"electron-is":void 0,"electron-log":void 0,"fs-extra":void 0,globby:void 0,"iconv-lite":void 0,lodash:void 0,"node-fetch":void 0,os:void 0,path:void 0,q:void 0,"sudo-prompt":void 0}]},{},[3]);