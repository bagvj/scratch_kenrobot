"use strict";var _slicedToArray=function(){function e(e,r){var t=[],n=!0,o=!1,i=void 0;try{for(var a,s=e[Symbol.iterator]();!(n=(a=s.next()).done)&&(t.push(a.value),!r||t.length!==r);n=!0);}catch(e){o=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(o)throw i}}return t}return function(r,t){if(Array.isArray(r))return r;if(Symbol.iterator in Object(r))return e(r,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();!function e(r,t,n){function o(a,s){if(!t[a]){if(!r[a]){var u="function"==typeof require&&require;if(!s&&u)return u(a,!0);if(i)return i(a,!0);var c=new Error("Cannot find module '"+a+"'");throw c.code="MODULE_NOT_FOUND",c}var f=t[a]={exports:{}};r[a][0].call(f.exports,function(e){var t=r[a][1][e];return o(t||e)},f,f.exports,e,r,t,n)}return t[a].exports}for(var i="function"==typeof require&&require,a=0;a<n.length;a++)o(n[a]);return o}({1:[function(e,r,t){function n(){J.transports.file.format="[{y}-{m}-{d} {h}:{i}:{s}] [{level}] {text}",E.dev()&&Q.dev?J.transports.file.level="debug":(J.transports.console=!1,J.transports.file.level="error")}function o(){var e=E.windows()?"pepflashplayer"+(N.isAppX64()?"64":"32")+".dll":E.macOS()?"PepperFlashPlayer.plugin":"libpepflashplayer.so";e=C.join(S("FlashPlayer"),e),J.debug("initFlashPlugin: "+e+" version: 26.0.0.131"),I.commandLine.appendSwitch("ppapi-flash-path",e),I.commandLine.appendSwitch("ppapi-flash-version","26.0.0.131")}function i(){var e=C.join(__dirname,".."),r=G();r.use("/",G.static(C.join(e,"public"))),r.listen(K)}function a(){I.on("ready",c).on("window-all-closed",function(e){return"darwin"!==process.platform&&I.quit()}).on("activate",function(e){return null===A&&f()}).on("will-quit",p).on("quit",function(e){return J.debug("app quit")})}function s(){u("getAppInfo",function(e){return N.resolvePromise(N.getAppInfo())}),u("getBaseUrl",function(e){return N.resolvePromise(X)}),u("loadSetting",function(e){return j()}),u("saveSetting",function(e){return y(e)}),u("execFile",function(e){return N.execFile(e)}),u("execCommand",function(e,r){return N.execCommand(e,r)}),u("spawnCommand",function(e,r,t){return N.spawnCommand(e,r,t)}),u("readFile",function(e,r){return N.readFile(e,r)}),u("writeFile",function(e,r){return N.writeFile(e,r)}),u("moveFile",function(e,r,t){return N.moveFile(e,r,t)}),u("removeFile",function(e){return N.removeFile(e)}),u("showOpenDialog",function(e){return N.showOpenDialog(e)}),u("showSaveDialog",function(e){return N.showSaveDialog(e)}),u("request",function(e,r,t){return N.request(e,r,t)}),u("showItemInFolder",function(e){return k.showItemInFolder(C.normalize(e))}),u("openUrl",function(e){return N.resolvePromise(e&&k.openExternal(e))}),u("download",function(e,r){return b(e,r)}),u("installDriver",function(e){return w(e)}),u("checkUpdate",function(e){return v(e)}),u("removeOldVersions",function(e){return m(e)}),u("setToken",function(e){return z.set(e)}),u("saveToken",function(e){return z.save(e)}),u("loadToken",function(e){return z.load(e)}),u("removeToken",function(e){return z.remove()}),u("projectSave",function(e,r,t){return U.save(e,r,t)}),u("projectOpen",function(e,r){return U.open(e,r)}),u("projectNewSave",function(e,r,t,n){return U.newSave(e,r,t,n)}),u("projectNewSaveAs",function(e,r,t){return U.newSaveAs(e,r,t)}),u("projectNewOpen",function(e,r){return U.newOpen(e,r)}),u("projectSyncUrl",function(e){return U.setSyncUrl(e)}),u("projectSync",function(e){return U.sync()}),u("projectList",function(e){return U.list(e)}),u("projectUpload",function(e,r){return U.upload(e,r)}),u("projectDelete",function(e,r){return U.remove(e,r)}),u("projectDownload",function(e,r){return U.download(e,r)}),u("log",function(e,r){return(J[r]||J.debug).bind(J).call(e)}),u("copy",function(e,r){return q.writeText(e,r)}),u("quit",function(e){return I.quit()}),u("reload",function(e){return A.reload()}),u("fullscreen",function(e){return A.setFullScreen(!A.isFullScreen())}),u("min",function(e){return A.minimize()}),u("max",function(e){A.isFullScreen()?A.setFullScreen(!1):A.isMaximized()?A.unmaximize():A.maximize()}),u("errorReport",function(e){J.error("------ error message ------"),J.error(e.message+"("+e.src+" at line "+e.line+":"+e.col+")"),J.error(""+e.stack)})}function u(e,r){var t=this,n="app:"+e;T.on(n,function(e,o){for(var i=arguments.length,a=Array(i>2?i-2:0),s=2;s<i;s++)a[s-2]=arguments[s];(r.apply(t,a)||N.resolvePromise()).then(function(r){e.sender.send(n,o,!0,r)},function(r){e.sender.send(n,o,!1,r)},function(r){e.sender.send(n,o,"notify",r)})})}function c(){J.debug("app ready"),E.dev()&&Q.devTool&&B({showDevTools:!0}),h().then(function(e){P=e,f(),d(),l()})}function f(){A=new _({width:1200,height:720,minWidth:1200,minHeight:720,frame:!1,show:!1,webPreferences:{plugins:!0,webSecurity:!1}}),Q.fullscreen?A.setFullScreen(!0):Q.maximize&&A.maximize(),A.on("closed",function(e){return A=null}).once("ready-to-show",function(e){return A.show()}).on("enter-full-screen",function(e){return N.postMessage("app:onFullscreenChange",!0)}).on("leave-full-screen",function(e){return N.postMessage("app:onFullscreenChange",!1)}),A.webContents.session.on("will-download",x),A.loadURL(X),A.focus()}function p(){N.removeFile(C.join(N.getAppDataPath(),"temp"),!0)}function d(){E.dev()||P.version==N.getVersion()||(P.version=N.getVersion(),P.reportInstall=!1,F=!0,g(!0))}function l(){if(!E.dev()&&!P.reportInstall){var e=N.getAppInfo(),r={version:e.version,platform:e.platform,bit:e.bit,ext:e.ext,branch:e.branch,feature:e.feature,installTime:N.stamp()};N.request("http://userver.kenrobot.com/statistics/installations",{method:"post",data:{data:JSON.stringify(r)}}).then(function(e){P.reportInstall=!0,g()},function(e){e&&J.error(e)})}}function v(e){var r=R.defer(),t=N.getAppInfo(),n=e+"&appname="+t.name+"&release_version="+t.branch+"&version="+t.version+"&platform="+t.platform+"&arch="+t.arch+"&ext="+t.ext+"&features="+t.feature;return J.debug("checkUpdate: "+n),N.request(n).then(function(e){r.resolve(e)},function(e){e&&J.error(e),r.reject(e)}),r.promise}function m(e){var r=R.defer();if(E.dev())return setTimeout(function(e){r.resolve()},10),r.promise;var t=N.getAppInfo(),n=C.join(N.getAppDataPath(),"download");return N.searchFiles(n+"/"+t.name+"-*."+t.ext).then(function(t){var o=/\d+\.\d+\.\d+/;t.map(function(e){return C.basename(e)}).filter(function(r){var t=r.match(o);return!!t&&N.versionCompare(t[0],e)<0}).forEach(function(e){N.removeFile(C.join(n,e),!0)}),r.resolve()},function(e){e&&J.error(e),r.reject(e)}),r.promise}function h(){var e=R.defer();J.debug("loadConfig");var r=C.join(N.getAppDataPath(),"config.json");return L.existsSync(r)?(N.readJson(r).then(function(r){e.resolve(r)},function(r){e.resolve({})}),e.promise):(setTimeout(function(r){e.resolve({})},10),e.promise)}function g(e){var r=C.join(N.getAppDataPath(),"config.json");return N.writeJson(r,P,null,e)}function j(){return N.resolvePromise(P.setting||{})}function y(e){return P.setting=e,g()}function x(e,r,t){var n=r.getURL(),o=n.lastIndexOf("#"),i=O.parse(n.substring(o+1));n=n.substring(0,o);var a=i.deferId,s=C.join(N.getAppDataPath(),"download",r.getFilename());if(i.checksum&&L.existsSync(s)){o=i.checksum.indexOf(":");var u=i.checksum.substring(0,o);if(i.checksum.substring(o+1)==W.fromFileSync(s,{algorithm:u}))return r.cancel(),J.debug("download cancel, "+n+" has cache"),void N.callDefer(a,!0,{path:s})}r.setSavePath(s);var c=r.getTotalBytes();r.on("updated",function(e,t){"interrupted"==t?(J.debug("download interrupted: "+n),N.callDefer(a,!1,{path:s})):"progressing"===t&&(r.isPaused()?(J.debug("download paused: "+n),N.callDefer(a,!1,{path:s})):N.callDefer(a,"notify",{path:s,totalSize:c,size:r.getReceivedBytes()}))}),r.once("done",function(e,r){"completed"==r?(J.debug("download success: "+n+", at "+s),N.callDefer(a,!0,{path:s})):(J.debug("download fail: "+n),N.callDefer(a,!1,{path:s}))})}function b(e,r){var t=R.defer(),n=N.getDefer(),o=n.deferId,i=n.promise;r.deferId=o;var a=O.stringify(r);return J.debug("download "+e+", options: "+a),i.then(function(e){t.resolve(e)},function(e){e&&J.error(e),t.reject(e)},function(e){t.notify(e)}),A.webContents.downloadURL(e+"#"+a),t.promise}function w(e){var r=R.defer();J.debug("installDriver: "+e);var t=C.join(N.getAppDataPath(),"temp");return N.unzip(e,t).then(function(n){var o=C.join(t,C.basename(e,C.extname(e)),"setup.exe");N.execFile(o).then(function(e){r.resolve()})},function(e){e&&J.error(e),r.reject(e)}),r.promise}function S(e){return C.join(N.getAppResourcePath(),"plugins",e,N.getPlatform())}var P,A,F,D=e("electron"),I=D.app,_=D.BrowserWindow,T=D.ipcMain,k=D.shell,q=D.clipboard,C=(D.webContents,e("path")),O=(e("os"),e("querystring")),N=(e("crypto"),e("./util")),z=e("./token"),U=e("./project"),E=e("electron-is"),B=e("electron-debug"),J=e("electron-log"),R=e("q"),L=e("fs-extra"),M=e("minimist"),W=e("hasha"),G=e("express"),K=8776,X="http://localhost:"+K,Q=M(process.argv.slice(1));process.on("uncaughtException",function(e){var r=e.stack||e.name+": "+e.message;J.error(r),I.quit()}),n(),o(),i(),I.makeSingleInstance(function(e,r){A&&(A.isMinimized()&&A.restore(),A.focus())})&&I.quit(),a(),s(),J.debug("app start, version "+N.getVersion())},{"./project":2,"./token":3,"./util":4,crypto:void 0,electron:void 0,"electron-debug":void 0,"electron-is":void 0,"electron-log":void 0,express:void 0,"fs-extra":void 0,hasha:void 0,minimist:void 0,os:void 0,path:void 0,q:void 0,querystring:void 0}],2:[function(e,r,t){function n(e){var r=I.defer();e=e||"all",T.debug("project list: "+e);var t=C.get();if(!t||!A)return q.rejectPromise(null,r);var n=t.user_id,o=q.stamp(),i=q.rsa_encrypt("Kenrobot-"+n+"-"+o),a=A+"/list";return q.request(a,{method:"post",data:{id:n,stamp:o,sign:i,type:e}}).then(function(e){0==e.status?r.resolve(e.data):r.reject(e.message)},function(e){e&&T.error(e),r.reject(e)}),r.promise}function o(e,r){var t=I.defer();T.debug("project upload: "+e+" "+r);var n=C.get();if(!n||!A)return q.rejectPromise(null,t);var o=n.user_id,i=q.stamp(),a=q.rsa_encrypt("Kenrobot-"+o+"-"+i);return s(y(o,r),e,r).then(function(n){var s=A+"/upload";q.request(s,{method:"post",headers:{id:o,stamp:i,sign:a,name:encodeURI(e),type:r},body:D.createReadStream(n)}).then(function(n){if(0==n.status){var o=n.data;v(o.name,o.type,o.modify_time).then(function(n){T.debug("project upload success: "+e+" "+r),t.resolve(o)},function(e){e&&T.error(e),t.reject(e)})}else t.reject(n.message)},function(e){e&&T.error(e),t.reject(e)})},function(e){e&&T.error(e),t.reject(e)}),t.promise}function i(e,r){var t=I.defer();T.debug("project download: "+e+" "+r);var n=C.get();if(!n||!A)return q.rejectPromise(null,t);var o=n.user_id,i=q.stamp(),a=q.rsa_encrypt("Kenrobot-"+o+"-"+i),s={id:o,stamp:i,sign:a,name:e,type:r},c=A+"/download";return q.request(c,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)},!1).then(function(n){var i=parseInt(n.headers.get("modify_time")),a=F.join(q.getAppDataPath(),"temp",q.uuid(6)+".zip");D.ensureDirSync(F.dirname(a));var s=D.createWriteStream(a);n.body.pipe(s),n.body.on("end",function(n){u(a,y(o,r),e,r).then(function(n){v(e,r,i).then(function(n){T.debug("project download success: "+e+" "+r),t.resolve()},function(e){e&&T.error(e),t.reject(e)})},function(e){e&&T.error(e),t.reject(e)})}).on("error",function(e){e&&T.error(e),t.reject(e)})},function(e){e&&T.error(e),t.reject(e)}),t.promise}function a(){var e=I.defer();return T.debug("project sync"),I.all([n(),h()]).then(function(r){var t=_slicedToArray(r,2);f(t[0],t[1]).then(function(r){T.debug("project sync success"),e.resolve()},function(r){T.debug("project sync fail"),r&&T.error(r),e.reject(r)},function(r){e.notify(r)})},function(r){r&&T.error(r),e.reject(r)}),e.promise}function s(e,r,t){var n=I.defer(),o=new k,i=x(r,t);switch(t){case"edu":case"ide":o.file(i+"/"+r+".ino",D.createReadStream(F.join(e,i+"/"+r+".ino"))),o.file(i+"/project.json",D.createReadStream(F.join(e,i+"/project.json")));break;case"scratch2":case"scratch3":o.file(i,D.createReadStream(F.join(e,i)))}var a=F.join(q.getAppDataPath(),"temp",q.uuid(6)+".zip");return D.ensureDirSync(F.dirname(a)),o.generateNodeStream({streamFiles:!0,type:"nodebuffer"}).pipe(D.createWriteStream(a)).on("finish",function(e){n.resolve(a)}).on("error",function(e){e&&T.error(e),n.reject(e)}),n.promise}function u(e,r,t,n){var o=I.defer();return q.unzip(e,r).then(function(e){T.error("unzip success: "+t+" "+n),o.resolve()},function(e){e&&T.error(e),o.reject(e)}),o.promise}function c(e,r){var t=C.get();if(!t)return!1;var n=y(t.user_id,r),o=F.join(n,x(e,r));return D.existsSync(o)}function f(e,r){var t=I.defer(),n=p(e,r),o=_slicedToArray(n,2),i=o[0],a=o[1];T.debug("doSync: downloadList:"+i.length+", uploadList:"+a.length);var s=i.length+a.length,u=0,c=function(e,r,n){u++,t.notify({total:s,count:u,name:e,type:r,action:n})};return d(i,c).then(l(a,c)).then(function(e){t.resolve()}).catch(function(e){e&&T.error(e),t.reject(e)}),t.promise}function p(e,r){var t={},n={};e.forEach(function(e){t[e.name+"-"+e.type]=e}),r.forEach(function(e){n[e.name+"-"+e.type]=e});var o=[],i=[];return e.forEach(function(e){var r=e.name+"-"+e.type,t=n[r];!t||!t.modify_time||t.modify_time<e.modify_time?o.push(e):c(e.name,e.type)||o.push(e)}),r.forEach(function(e){var r=e.name+"-"+e.type,n=t[r];(!n||n.modify_time<e.modify_time)&&i.push(e)}),[o,i]}function d(e,r){var t,n=I.defer();return(t=function(o){if(0==e.length)return q.resolvePromise(!0,n);var a=e.shift();i(a.name,a.type).then(function(o){r(a.name,a.type,"download"),0==e.length?n.resolve():setTimeout(function(e){return t()},100)},function(e){e&&T.error(e),n.reject(e)})})(),n.promise}function l(e,r){var t,n=I.defer();return(t=function(i){if(0==e.length)return q.resolvePromise(!0,n);var a=e.shift();o(a.name,a.type).then(function(o){r(a.name,a.type,"upload"),0==e.length?n.resolve():setTimeout(function(e){return t()},100)},function(e){e&&T.error(e),n.reject(e)})})(),n.promise}function v(e,r,t){var n=I.defer();return h().then(function(o){var i=o.find(function(r){return r.name==e});i?i.modify_time=t:o.push({name:e,type:r,modify_time:t}),g(o).then(function(e){n.resolve()},function(e){e&&T.error(e),n.reject(e)})},function(e){e&&T.error(e),n.reject(e)}),n.promise}function m(e){var r=I.defer();return h().then(function(t){var n=t.findIndex(function(r){return r.name==e});n<0?r.resolve():(t.splice(n,1),g(t).then(function(e){r.resolve()},function(e){e&&T.error(e),r.reject(e)}))},function(e){e&&T.error(e),r.reject(e)}),r.promise}function h(){var e=I.defer(),r=C.get();if(!r)return q.rejectPromise(null,e);var t=j(r.user_id);return D.existsSync(t)?q.readJson(t):q.resolvePromise([],e)}function g(e){var r=C.get();return r?q.writeJson(j(r.user_id),e):q.rejectPromise()}function j(e){return F.join(q.getAppDataPath(),"projects",b(e,1),"list.json")}function y(e,r){return F.join(q.getAppDocumentPath(),"projects",b(e),r)}function x(e,r){var t;switch(r){case"edu":case"ide":t=e;break;case"scratch2":t=e+".sb2";break;case"scratch3":t=e+".json"}return t}function b(e,r){return r=r||0,_(""+e,{algorithm:"md5"}).substring(8*r,8*(r+1))}function w(e,r,t,n){var o=I.defer(),i=function(n){S(e,r,t,n).then(function(t){o.resolve({name:e,type:r,path:n,tag:"local"})},function(e){e&&T.error(e),o.reject(e)})};if(n)i(n);else{var a={};a.defaultPath=F.join(q.getAppPath("documents"),x(e,r)),"scratch2"==r?a.filters=[{name:"sb2",extensions:["sb2"]}]:"scratch3"==r&&(a.filters=[{name:"json",extensions:["json"]}]),q.showSaveDialog(a).then(function(e){i(e)},function(e){e&&T.error(e),o.reject(e)})}return o.promise}function S(e,r,t,n){return T.debug("project save: "+e+" "+r+" -> "+n),"edu"==r?I.all([q.writeFile(F.join(n,e+".ino"),t.project_data.code),q.writeJson(F.join(n,"project.json"),t)]):"ide"==r?I.all([q.writeFile(F.join(n,e+".ino"),t.project_data.code),q.writeJson(F.join(n,"project.json"),t)]):"scratch2"==r?q.writeFile(n,new Buffer(t,"base64")):"scratch3"==r?q.writeFile(n,t):q.rejectPromise()}function P(e,r){var t=I.defer();if(T.debug("project open: "+r+" -> "+e),"edu"==r)q.readJson(F.join(e,"project.json")).then(function(n){t.resolve({extra:{name:F.basename(e),type:r,path:e},data:n})},function(e){e&&T.error(e),t.reject(e)});else if("ide"==r){var n=F.dirname(e),o=F.basename(e,F.extname(e));if(F.basename(n)!=o)return q.rejectPromise({path:e,newPath:F.join(n,o,o+".ino"),status:"DIR_INVALID"},t);q.readFile(e).then(function(e){t.resolve({extra:{name:o,type:r,path:n},data:e})},function(e){e&&T.error(e),t.reject(e)})}else"scratch2"==r?q.readFile(e,"base64").then(function(n){t.resolve({extra:{name:F.basename(e,F.extname(e)),type:r,path:e},data:n})},function(e){e&&T.error(e),t.reject(e)}):"scratch3"==r?q.readFile(e).then(function(n){t.resolve({extra:{name:F.basename(e,F.extname(e)),type:r,path:e},data:n})},function(e){e&&T.error(e),t.reject(e)}):q.rejectPromise(null,t);return t.promise}var A,F=e("path"),D=e("fs-extra"),I=e("q"),_=e("hasha"),T=e("electron-log"),k=e("jszip"),q=e("./util"),C=e("./token"),O=q.throttle(a,3e3);r.exports.setSyncUrl=function(e){T.debug("project setSyncUrl: "+e),A=e},r.exports.sync=a,r.exports.list=n,r.exports.upload=o,r.exports.remove=function(e,r){var t=I.defer();T.debug("project remove: "+e+" "+r);var n=C.get();if(!n||!A)return q.rejectPromise(null,t);var o=n.user_id,i=q.stamp(),a=q.rsa_encrypt("Kenrobot-"+o+"-"+i),s=A+"/delete";return q.request(s,{method:"post",data:{id:o,stamp:i,sign:a,name:e,type:r}}).then(function(n){0==n.status?I.all([q.removeFile(F.join(y(o,r),x(e,r))),m(e)]).then(function(n){T.debug("project remove success: "+e+" "+r),t.resolve()},function(e){e&&T.error(e),t.reject(e)}):t.reject(n.message)},function(e){e&&T.error(e),t.reject(e)}),t.promise},r.exports.download=i,r.exports.newSave=function(e,r,t,n){var o=I.defer(),i=C.get();if(!i){var a=F.join(q.getAppDocumentPath(),"projects");return n&&n.startsWith(a)&&(n=null),w(e,r,t,n)}var s=y(i.user_id,r);return n=F.join(s,x(e,r)),S(e,r,t,n).then(function(t){v(e,r,q.stamp()).then(function(t){O(),o.resolve({name:e,type:r,path:n,tag:"network"})},function(e){e&&T.error(e),o.reject(e)})},function(e){e&&T.error(e),o.reject(e)}),o.promise},r.exports.newSaveAs=w,r.exports.newOpen=function(e,r){var t=I.defer();T.debug("project open: "+e);var n=function(r){P(r,e).then(function(e){t.resolve(e)},function(e){e&&T.error(e),t.reject(e)})},o=C.get();if(r){if(!o)return q.rejectPromise(null,t);var i=F.join(y(o.user_id,e),x(r,e));return n(i),t.promise}var a={};return a.defaultPath=o?y(o.user_id,e):q.getAppPath("documents"),"edu"==e?a.properties=["openDirectory"]:"ide"==e?(a.properties=["openFile"],a.filters=[{name:"ino",extensions:["ino"]}]):"scratch2"==e?(a.properties=["openFile"],a.filters=[{name:"sb2",extensions:["sb2"]}]):"scratch3"==e&&(a.properties=["openFile"],a.filters=[{name:"json",extensions:["json"]}]),q.showOpenDialog(a).then(function(e){n(e)},function(e){e&&T.error(e),t.reject(e)}),t.promise}},{"./token":3,"./util":4,"electron-log":void 0,"fs-extra":void 0,hasha:void 0,jszip:void 0,path:void 0,q:void 0}],3:[function(e,r,t){function n(){return i.join(c.getAppDataPath(),"token")}var o,i=e("path"),a=e("crypto"),s=e("q"),u=e("fs-extra"),c=e("./util"),f=e("electron-log");r.exports.get=function(){return o},r.exports.set=function(e){o=e},r.exports.remove=function(){o=null,c.removeFile(n(),!0)},r.exports.save=function(e){var r=s.defer(),t=a.randomBytes(128);return c.writeFile(n(),c.encrypt(JSON.stringify(e),t)).then(function(e){r.resolve(t.toString("hex"))},function(e){e&&f.error(e),r.reject(e)}),r.promise},r.exports.load=function(e){var r=s.defer(),t=n();return u.existsSync(t)?(c.readFile(t,"utf8").then(function(t){try{var n=c.decrypt(t,Buffer.from(e,"hex"));r.resolve(JSON.parse(n))}catch(e){r.reject()}},function(e){e&&f.error(e),r.reject(e)}),r.promise):(setTimeout(function(e){r.reject()},10),r.promise)}},{"./util":4,crypto:void 0,"electron-log":void 0,"fs-extra":void 0,path:void 0,q:void 0}],4:[function(e,r,t){function n(){return"x64"===process.arch||process.env.hasOwnProperty("PROCESSOR_ARCHITEW6432")}function o(){return j.windows()?"win":j.macOS()?"mac":c.arch().indexOf("arm")>=0?"arm":"linux"}function i(){return j.dev()?F.version:v.getVersion()}function a(){return parseInt((new Date).getTime()/1e3)}function s(e,r,t){var n=y.defer();return r=r||{},t=t||!1,g.debug("execCommand:"+e+", options: "+JSON.stringify(r)+", useSudo: "+t),t?w.exec(e,{name:"kenrobot"},function(e,r,t){if(r=j.windows()?S.decode(r||"","gbk"):r,t=j.windows()?S.decode(t||"","gbk"):t,e)return g.error(e),r&&g.error(r),t&&g.error(t),void n.reject(t||r||e);j.dev()&&g.debug(r),n.resolve(r)}):f.exec(e,r,function(e,r,t){if(r=j.windows()?S.decode(r||"","gbk"):r,t=j.windows()?S.decode(t||"","gbk"):t,e)return g.error(e),r&&g.error(r),t&&g.error(t),void n.reject(t||r||e);j.dev()&&g.debug(r),n.resolve(r)}),n.promise}function u(e,r,t){var n=y.defer(),o=f.spawn(e,r,t),i="",a="";return o.stdout.on("data",function(e){var r=j.windows()?S.decode(e,"gbk"):e.toString();j.dev()&&g.debug(r),i+=r,n.notify({type:"stdout",data:r})}),o.stderr.on("data",function(e){var r=j.windows()?S.decode(e,"gbk"):e.toString();j.dev()&&g.debug(r),a+=r,n.notify({type:"stderr",data:r})}),o.on("close",function(e){0==e?n.resolve(i):n.reject(a)}),n.promise}var c=e("os"),f=e("child_process"),p=e("path"),d=e("crypto"),l=e("electron"),v=l.app,m=l.dialog,h=l.BrowserWindow,g=e("electron-log"),j=e("electron-is"),y=e("q"),x=e("fs-extra"),b=e("glob"),w=e("sudo-prompt"),S=e("iconv-lite"),P=e("7zip-bin").path7za.replace("app.asar","app.asar.unpacked"),A=e("node-fetch"),F=e("../package"),D="-----BEGIN PUBLIC KEY-----\nMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC7Jat1/19NDxOObrFpW8USTia6\nuHt34Sac1Arm6F2QUzsdUEUmvGyLIOIGcdb+F6pTdx4ftY+wZi7Aomp4k3vNqXmX\nT0mE0vpQlCmsPUcMHXuUi93XTGPxLXIv9NXxCJZXSYI0JeyuhT9/ithrYlbMlyNc\nwKB/BwSpp+Py2MTT2wIDAQAB\n-----END PUBLIC KEY-----\n";j.dev()&&v.setName(F.name);var I={},_=0;r.exports.isX64=n,r.exports.isAppX64=function(){return j.dev()?n():64==F.buildInfo.bit},r.exports.getPlatform=o,r.exports.getVersion=i,r.exports.getAppInfo=function(){var e={bit:n()?64:32,arch:process.arch,platform:o(),version:i(),name:v.getName()};return j.dev()?(e.ext=p.extname(v.getPath("exe")).replace(".",""),e.branch="beta",e.feature="",e.date=a()):(e.ext=F.buildInfo.ext,e.branch=F.buildInfo.branch,e.feature=F.buildInfo.feature,e.date=F.buildInfo.date),e},r.exports.getAppDataPath=function(){return p.join(v.getPath("appData"),v.getName())},r.exports.getAppResourcePath=function(){return j.windows()||j.dev()?p.resolve("."):p.resolve(v.getAppPath(),"..","..")},r.exports.getAppDocumentPath=function(){return p.join(v.getPath("documents"),v.getName())},r.exports.getAppPath=function(e){return v.getPath(e)},r.exports.versionCompare=function(e,r){for(var t=/(\d+)\.(\d+)\.(\d+)/,n=t.exec(e),o=t.exec(r),i=[parseInt(n[1]),parseInt(n[2]),parseInt(n[3])],a=[parseInt(o[1]),parseInt(o[2]),parseInt(o[3])],s=0;s<=2;s++)if(i[s]!=a[s])return i[s]>a[s]?1:-1;return 0},r.exports.postMessage=function(e){for(var r=arguments.length,t=Array(r>1?r-1:0),n=1;n<r;n++)t[n-1]=arguments[n];g.debug("postMessage: "+e+", "+t.join(", "));var o=h.getAllWindows();o&&o.length&&o[0].webContents.send(e,t)},r.exports.getDefer=function(){var e=y.defer(),r=_++;return I[r]=e,{deferId:r,promise:e.promise}},r.exports.callDefer=function(e,r){var t=I[e];if(t){var n;"notify"==r?n=t.notify:(delete I[e],n=r?t.resolve:t.reject);for(var o=arguments.length,i=Array(o>2?o-2:0),a=2;a<o;a++)i[a-2]=arguments[a];n.apply(this,i)}},r.exports.handleQuotes=function(e){return j.windows()?e:e.replace(/"/g,"")},r.exports.uuid=function(e,r){var t,n="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),o=[];if(r=r||n.length,e)for(t=0;t<e;t++)o[t]=n[0|Math.random()*r];else{var i;for(o[8]=o[13]=o[18]=o[23]="-",o[14]="4",t=0;t<36;t++)o[t]||(i=0|16*Math.random(),o[t]=n[19==t?3&i|8:i])}return o.join("")},r.exports.stamp=a,r.exports.throttle=function(e,r){var t;return function(n){t&&clearTimeout(t),t=setTimeout(function(r){e(),clearTimeout(t),t=null},r)}},r.exports.encrypt=function(e,r,t){t=t||"aes-128-cbc";var n=d.createCipher(t,r),o=n.update(e,"utf8","binary");return o+=n.final("binary"),o=new Buffer(o,"binary").toString("base64")},r.exports.decrypt=function(e,r,t){t=t||"aes-128-cbc",e=new Buffer(e,"base64").toString("binary");var n=d.createDecipher(t,r),o=n.update(e,"binary","utf8");return o+=n.final("utf8")},r.exports.rsa_encrypt=function(e,r){r=r||D;var t=new Buffer(e);return d.publicEncrypt({key:r,padding:d.constants.RSA_PKCS1_PADDING},t).toString("base64")},r.exports.rsa_decrypt=function(e,r){var t=new Buffer(e,"base64");return d.privateDecrypt({key:r,padding:d.constants.RSA_PKCS1_PADDING},t).toString("utf8")},r.exports.resolvePromise=function(e,r){return r=r||y.defer(),setTimeout(function(t){r.resolve(e)},10),r.promise},r.exports.rejectPromise=function(e,r){return r=r||y.defer(),setTimeout(function(t){r.reject(e)},10),r.promise},r.exports.execFile=function(e){var r=y.defer();g.debug("execFile: "+e);var t;return t=j.windows()?"start /WAIT "+e:""+e,s(t,null,!0).fin(function(e){r.resolve()}),r.promise},r.exports.execCommand=s,r.exports.spawnCommand=u,r.exports.readFile=function(e,r,t){if(t)return x.readFileSync(e,r);var n=y.defer();return r=r||"utf8",x.readFile(e,r,function(e,r){if(e)return g.error(e),void n.reject(e);n.resolve(r)}),n.promise},r.exports.writeFile=function(e,r,t,n){if(!n){var o=y.defer();return x.outputFile(e,r,t,function(e){if(e)return g.error(e),void o.reject(e);o.resolve()}),o.promise}x.outputFileSync(e,r,t)},r.exports.moveFile=function(e,r,t){var n=y.defer();return t=t||{overwrite:!0},x.move(e,r,t,function(e){if(e)return g.error(e),void n.reject(e);n.resolve()}),n.promise},r.exports.removeFile=function(e,r){if(!r){var t=y.defer();return x.remove(e,function(e){if(e)return g.error(e),void t.reject(e);t.resolve()}),t.promise}x.removeSync(e)},r.exports.readJson=function(e,r){var t=y.defer();return r=r||{},x.readJson(e,r,function(e,r){if(e)return g.error(e),void t.reject(e);t.resolve(r)}),t.promise},r.exports.writeJson=function(e,r,t,n){if(!n){var o=y.defer();return t=t||{},x.outputJson(e,r,t,function(e){if(e)return g.error(e),void o.reject(e);o.resolve()}),o.promise}x.outputJsonSync(e,r,t)},r.exports.searchFiles=function(e){var r=y.defer();return g.debug("searchFiles: "+e),b(e,{},function(e,t){return e?(g.error(e),void r.reject(e)):r.resolve(t)}),r.promise},r.exports.unzip=function(e,r,t){var n=y.defer(),o=/([\d]+)% \d+ - .*\r?/g;return g.debug("unzip: "+e+" => "+r),t?u('"'+P+'"',["x",'"'+e+'"',"-bsp1","-y",'-o"'+r+'"'],{shell:!0}).then(function(e){n.resolve(e)},function(e){e&&g.error(e),n.reject(e)},function(e){if(o.lastIndex=0,o.test(e.data)){var r,t=o.exec(e.data);do{r=t,t=o.exec(e.data)}while(t);n.notify(parseInt(r[1]))}}):s('"'+P+'" x "'+e+'" -y -o"'+r+'"').then(function(e){n.resolve()},function(e){e&&g.error(e),n.reject(e)}),n.promise},r.exports.zip=function(e,r,t,n){var o=y.defer();return r=r instanceof Array?r:[r],n=n||"7z",s('cd "'+e+'" && "'+P+'" a -t'+n+" -r "+t+" "+r.join(" ")).then(function(e){o.resolve()},function(e){e&&g.error(e),o.reject(e)}),o.promise},r.exports.showOpenDialog=function(e,r){var t=y.defer();return e=e||{},e.title="打开",e.defaultPath=e.defaultPath||v.getPath("documents"),e.buttonLabel="打开",r=r||h.getAllWindows()[0],m.showOpenDialog(r,e,function(e){e?t.resolve(e[0]):t.reject()}),t.promise},r.exports.showSaveDialog=function(e,r){var t=y.defer();return e=e||{},e.title="保存",e.defaultPath=e.defaultPath||v.getPath("documents"),e.buttonLabel="保存",r=r||h.getAllWindows()[0],m.showSaveDialog(r,e,function(e){e?t.resolve(e):t.reject()}),t.promise},r.exports.request=function(e,r,t){var n=y.defer();if(r=r||{},t=!1!==t,r.method=r.method||"GET",t&&r.data){r.body=JSON.stringify(r.data);var o=r.headers||(r.headers={});o["Content-Type"]="application/json",o.Accept="application/json",delete r.data}return A(e,r).then(function(e){if(e.ok)return t?e.json():e;var r=new Error(e.statusText);throw r.status=e.status,r}).then(function(e){n.resolve(e)}).catch(function(e){e&&g.error(e),n.reject(e)}),n.promise}},{"../package":void 0,"7zip-bin":void 0,child_process:void 0,crypto:void 0,electron:void 0,"electron-is":void 0,"electron-log":void 0,"fs-extra":void 0,glob:void 0,"iconv-lite":void 0,"node-fetch":void 0,os:void 0,path:void 0,q:void 0,"sudo-prompt":void 0}]},{},[1]);